# Техническая документация ARC-Estimate

> Документация для разработчиков на русском языке

---

## Оглавление

1. [Введение](#введение)
2. [Технологический стек](#технологический-стек)
3. [Структура проекта](#структура-проекта)
4. [Система координат](#система-координат)
5. [Архитектура камеры](#архитектура-камеры)
6. [Рендеринг сетки](#рендеринг-сетки)
7. [Этапы разработки](#этапы-разработки)

---

## Введение

ARC-Estimate — это 2D инструмент архитектурного проектирования для Windows 10/11, 
предназначенный для создания планов помещений с автоматическим расчётом смет.

---

## Технологический стек

| Компонент | Технология | Версия |
|-----------|------------|--------|
| Платформа | Windows 10/11 | 10.0.19041+ |
| UI Framework | WinUI 3 | 1.8.x |
| Язык | C++/WinRT | C++17 |
| 2D Графика | Win2D | 1.3.0 |
| SDK | Windows App SDK | 1.8.260101001 |

---

## Структура проекта

```
estimate1/
??? docs/                    # Документация
??? Camera.h                 # Класс камеры
??? GridRenderer.h           # Рендерер сетки
??? Element.h                # Базовый класс элементов, Wall, DocumentModel
??? WallRenderer.h           # Рендерер стен
??? DrawingTools.h           # Инструменты рисования (WallTool, SelectTool, SnapManager)
??? Dimension.h              # Размеры и цепочки размеров
??? DimensionRenderer.h      # Рендерер размеров
??? AutoDimensionManager.h   # Автоматическое создание размеров
??? Layer.h                  # Система слоёв
??? Material.h               # Материалы
??? WallType.h               # Типы стен
??? WallJoinManager.h        # Соединения стен (L/T-joins)
??? WallJoinSystem.h         # R2: Система соединений с митра-углами
??? Room.h                   # R5: Модель помещения
??? RoomDetector.h           # R5: Детектор помещений по стенам
??? RoomRenderer.h           # R5: Рендерер помещений
??? Zone.h                   # R5.5: Зоны (группировка помещений)
??? Opening.h                # R4: Двери и окна
??? OpeningTools.h           # R4: Инструменты размещения дверей/окон
??? OpeningRenderer.h        # R4: Рендерер дверей и окон
??? EditTools.h              # R2.5: Инструменты Trim/Extend/Split
??? DxfParser.h              # Парсер DXF файлов
??? DxfReference.h           # DXF-подложки
??? DxfReferenceRenderer.h   # Рендерер DXF
??? IfcParser.h              # Парсер IFC файлов
??? IfcReference.h           # IFC-подложки
??? IfcReferenceRenderer.h   # Рендерер IFC
??? EstimationEngine.h       # Движок расчёта смет
??? ExcelExporter.h          # Экспорт в Excel/CSV
??? UndoManager.h            # Система отмены/повтора
??? WallTypeEditor.h         # Редактор типов стен
??? ProjectSerializer.h      # Сериализация проекта
??? MainViewModel.*          # Модель представления
??? MainWindow.*             # Главное окно
??? App.*                    # Точка входа приложения
??? pch.h                    # Предкомпилированные заголовки
```

---

## Система координат

### Мировые координаты
- Все размеры хранятся в **миллиметрах**
- Начало координат (0, 0) в центре холста
- Ось X направлена вправо
- Ось Y направлена вниз

### Преобразование координат

```cpp
// Мировые -> Экранные
screen_x = (world_x + offset_x) * zoom + center_x
screen_y = (world_y + offset_y) * zoom + center_y

// Экранные -> Мировые
world_x = (screen_x - center_x) / zoom - offset_x
world_y = (screen_y - center_y) / zoom - offset_y
```

---

## Архитектура камеры

### Класс Camera (Camera.h)

```cpp
class Camera {
    WorldPoint m_offset;     // Смещение в мм
    double m_zoom;           // Пикселей на мм
    float m_canvasWidth;     // Ширина холста
    float m_canvasHeight;    // Высота холста
    
    // Преобразования
    ScreenPoint WorldToScreen(WorldPoint world);
    WorldPoint ScreenToWorld(ScreenPoint screen);
    
    // Управление
    void Pan(float deltaX, float deltaY);
    void ZoomAt(ScreenPoint center, double factor);
};
```

### Пределы масштабирования

| Параметр | Значение | Пояснение |
|----------|----------|-----------|
| minZoom | 0.01 | 1 пиксель = 100 мм |
| maxZoom | 10.0 | 10 пикселей = 1 мм |
| defaultZoom | 0.5 | 1 пиксель = 2 мм |

---

## Рендеринг сетки

### Класс GridRenderer (GridRenderer.h)

Сетка адаптируется к масштабу автоматически:

1. Вычисляется целевое расстояние между линиями (в пикселях)
2. Переводится в мировые единицы (мм)
3. Округляется до "красивых" значений (1, 2, 5 ? 10^n)

### Типы линий сетки

| Тип | Цвет | Толщина |
|-----|------|---------|
| Минорная | rgba(128,128,128,0.16) | 0.5px |
| Мажорная | rgba(128,128,128,0.31) | 1.0px |
| Оси | rgba(100,100,200,0.59) | 1.5px |

---

## Этапы разработки

### M0 — Базовая настройка проекта ?
- Инициализация проекта WinUI 3
- Настройка .gitignore
- Создание структуры документации

### M1 — Оболочка главного окна ?
- Меню на русском языке
- Панель инструментов
- Панель свойств
- Вкладки видов (Обмерный, Демонтаж, Новый)
- MainViewModel с INotifyPropertyChanged

### M2 — Движок холста Win2D ?
- Интеграция Win2D CanvasControl
- Класс Camera для преобразования координат
- Класс GridRenderer для адаптивной сетки
- Панорамирование (средняя/правая кнопка мыши)
- Масштабирование (колёсико мыши, центрируется на курсоре)
- Отображение координат курсора в мм

### M2.5 — Система слоёв ?
- Класс Layer (Layer.h):
  - Name, IsVisible, IsLocked, IsActive
  - Color для визуального отображения
  - LinkedWorkState для связи с рабочим состоянием
- LayerManager для управления коллекцией слоёв
- Связь слоёв с видами:
  - Обмерный ? только Существующее
  - Демонтаж ? Существующее + Демонтаж  
  - Новый ? Существующее + Новое
- UI панель слоёв в правой панели свойств
- Чекбоксы для переключения видимости

### M3 — Модель стен ?
- Базовый класс Element (Element.h):
  - Id, Name, WorkState, IsSelected
  - Виртуальные методы HitTest(), GetBounds()
- Класс Wall:
  - StartPoint, EndPoint (мм)
  - Thickness, Height
  - LocationLineMode (6 режимов)
  - Вычисляемые свойства: GetLength(), GetArea(), GetVolume()
- DocumentModel для хранения элементов
- WallRenderer для отрисовки (WallRenderer.h):
  - Отрисовка стен с толщиной
  - Превью при рисовании
  - Маркеры выделения
  - Стили для разных WorkState
- DrawingTools (DrawingTools.h):
  - SnapManager (привязка к сетке, концам, серединам)
  - WallTool (click-click рисование, цепочка стен)
  - SelectTool (выделение кликом)

### R5 — Помещения и зоны (статус: частично)
- **R5.1 Распознавание помещений** — реализовано автоматическое построение помещений по замкнутым контурам стен:
  - Граф стен с объединением узлов по допуску 5 мм и поиск циклов DFS (до глубины 12).
  - Дедупликация циклов через каноническое представление; отсев площадей < 1 м?.
  - Пересчёт при любом изменении стен в `DocumentModel::RebuildRooms()`, доступ через `GetRooms()`.
- **R5.2 Модель помещения** — расширенная модель Room (Room.h):
  - `RoomCategory` enum: Living, Wet, Service, Circulation, Balcony, Office
  - `RoomBoundary` структура для границ помещения
  - Вычисляемые свойства: площадь (м?), периметр (м), объём (м?), площадь стен (м?)
  - Отделка: пол, потолок, стены отдельно
  - Автоопределение категории по названию
- **R5.3 Визуализация** — RoomRenderer (RoomRenderer.h):
  - Полупрозрачная заливка по категории помещения
  - Метки с номером, названием и площадью
  - Hover-эффект, цветовая схема (10+ типов)
  - `RoomDisplaySettings` для настройки
- **R5.4 Сериализация** — сохранение/загрузка пользовательских данных:
  - `SerializeRooms()` / `DeserializeRooms()` в ProjectSerializer
  - Сопоставление по центроиду при загрузке
- R5.5 (зоны, панель свойств) — запланировано.
- Интеграция в MainWindow:
  - Рисование стен левой кнопкой мыши
  - Привязка при рисовании
  - Панель свойств для выбранной стены

### M3.1 — Типы стен и материалы ?
- Класс Material (штриховка, стоимость) ?
- Класс WallLayer (материал, толщина) ?
- Класс WallType (коллекция слоёв) ?
- Редактор типов стен ? (M6.5)

### M3.5 — Авторазмеры ?
- Класс Dimension с IsLocked (Anchor Lock)
- AutoDimensionManager (пересборка при изменении геометрии)
- DimensionRenderer для отображения размеров
- Панель свойств размера с Offset и Anchor Lock
- Ручной инструмент размера

### M4 — Продвинутое размещение стен ?
- 6 режимов линии размещения
- Переворот пробелом (Spacebar)
- L- и T-соединения (WallJoinManager)
- Запрет соединения (AllowJoinStart/End)
- Горячие клавиши: V, W, R, Space, Escape, Delete

### M5 — Импорт DXF ?
- Собственный парсер DXF (DxfParser.h)
- Поддержка LINE, POLYLINE, LWPOLYLINE, CIRCLE, ARC, TEXT, MTEXT
- Автоопределение единиц из заголовка DXF
- Диалог импорта с настройками масштаба и прозрачности
- DXF-подложка для трассировки (DxfReferenceLayer)
- Рендеринг дуг с bulge
- **Конвертация DXF в стены** ? (M6.5)

### M5.5 — Импорт IFC ?
- Собственный парсер IFC/STEP (IfcParser.h)
- Поддержка схем IFC2X3 и IFC4
- Парсинг сущностей:
  - IFCWALL, IFCWALLSTANDARDCASE ? стены
  - IFCDOOR ? двери
  - IFCWINDOW ? окна
  - IFCSPACE ? помещения
  - IFCSLAB ? перекрытия
  - IFCBUILDINGSTOREY ? этажи
- Автоопределение единиц (IFCSIUNIT, IFCCONVERSIONBASEDUNIT)
- Диалог импорта с выбором типов элементов
- IFC-подложка для трассировки (IfcReferenceLayer)
- Рендерер с цветовой кодировкой элементов
- **Конвертация IFC в стены** ? (M6.5)

### M5.6 — Система привязки к стенам ?
- WallSnapSystem с 10 типами привязки
- WallSnapRenderer для визуализации
- Tab для переключения режима привязки
- Привязка к граням и осям стен

### M6 — Сохранение/Загрузка ?
- ProjectSerializer для JSON сериализации
- Формат файла .arcp с UTF-8
- Сохранение камеры, слоёв, материалов, типов стен
- Ctrl+S / Ctrl+O / Ctrl+N

### M6.5 — Отложенные функции ?
- **Undo/Redo (Ctrl+Z/Ctrl+Y)** — система отмены/повтора
- **Редактор типов стен** — диалог для создания/редактирования типов
- **Конвертация DXF в стены** — преобразование линий в стены
- **Конвертация IFC в стены** — преобразование IfcWall в нативные стены

### M7 — Экспорт сметы ?
- EstimationEngine — расчёт количеств
- ExcelExporter — экспорт в Excel/CSV
- Группировка по WorkState, типу стен, материалам
- 10% непредвиденные расходы
- Диалог предпросмотра сметы

### M8 — Экспорт чертежа PDF ?
- PdfWriter — генератор PDF файлов
- PlanPdfExporter — экспорт плана
- Масштабы 1:50, 1:100, 1:200, 1:500
- Форматы A4, A3, A2, A1
- Штамп чертежа
- Экспорт стен и размеров

### M9 — Финальная полировка ?
- Все горячие клавиши (V, W, D, O, R, Delete, Escape, Tab, Space)
- Тултипы на русском
- Hover-эффект для стен
- Ручки выделения

### M9.5 — Тестирование ?
- 33 unit-теста для ключевых алгоритмов
- Тестовый фреймворк без зависимостей
- Меню "Справка" ? "Запустить тесты"
- Диалог "О программе"

---

## ?? ROADMAP v1.0 ЗАВЕРШЁН

Все milestones M0-M9.5 успешно реализованы!

---

## ROADMAP v2.0 — Улучшения и новые возможности

### R1 — Revit-подобный интерфейс ?
- **Ribbon (лента инструментов)** — вкладки Файл, Архитектура, Аннотации, Вид, Управление
- **Options Bar** — контекстная панель параметров под лентой
- **Панель свойств слева** — секции Зависимости, Размеры, Идентификация
- **Браузер проекта справа** — древовидная структура
- **Улучшенная статусная строка** — координаты, масштаб, режим привязки

### R2 — Система соединений стен ?
- **WallJoinSystem** (`WallJoinSystem.h`) — полная система соединений:
  - 4 типа соединений: L-join, T-join, X-join, Collinear
  - 3 типа стыков: Miter, Butt, Bevel
  - Расчёт геометрии митра-углов (CalculateMiterCorner)
  - Превью соединения при рисовании (FindPreviewJoin)
- **WallJoinRenderer** — визуализация соединений:
  - DrawJoinPreview() — превью точки соединения
  - DrawAngleIndicator() — угол между стенами
  - DrawJoinTypeBadge() — бэйдж типа (L/T/X/—)
- **EditTools.h** — инструменты редактирования:
  - TrimExtendTool — обрезать/удлинить стену
  - SplitTool — разделить стену
- **JoinSettings** — настройки соединений с сохранением в проекте

### R3 — Профессиональные размерные линии ?
- **DimensionTickType** — типы засечек:
  - Tick (архитектурная засечка)
  - Arrow (стрелка)
  - Dot (точка)
- **DimensionRenderer обновлён**:
  - DrawAnglePreview() — угол между направлениями
  - DrawAngleFromHorizontal() — угол от горизонтали при рисовании стены
  - DrawArc() — рисование дуги сегментами
  - Зелёный цвет для углов кратных 45°
  - Пунктирная горизонтальная линия-референс

### R4 — Двери и окна ?
- **Opening.h** — модели дверей и окон:
  - Door — дверь с типом открывания, дугой swing
  - Window — окно с типом, рамой, остеклением
  - DoorSwingType — 8 типов открывания
  - WindowType — 6 типов окон
- **OpeningTools.h** — инструменты размещения:
  - DoorPlacementTool — размещение дверей в стенах
  - WindowPlacementTool — размещение окон в стенах
- **OpeningRenderer.h** — визуализация:
  - DrawDoor() — дверь с проёмом и дугой
  - DrawWindow() — окно с рамой и стеклом
  - DrawDoorPreview(), DrawWindowPreview()

### R5 — Помещения и зоны ?
- **R5.1 Распознавание помещений** — автодетект замкнутых контуров:
  - RoomDetector: граф стен, поиск циклов DFS
  - Фильтрация по площади (>1 м?)
- **R5.2 Модель помещения** — Room.h:
  - RoomCategory enum (Living, Wet, Service, Circulation, Balcony, Office)
  - RoomBoundary для связи со стенами
  - Вычисляемые свойства: площадь, периметр, объём, площадь стен
  - Отделка: пол, потолок, стены
- **R5.3 Визуализация** — RoomRenderer.h:
  - Полупрозрачная заливка по типу помещения
  - Метки с номером, названием, площадью
  - Hover-эффект
- **R5.4 Марки** — автоматическое размещение в центроиде
- **R5.5 Зоны** — Zone.h:
  - ZoneType enum: Living, Wet, Service, Circulation, Outdoor, Custom
  - ZoneManager для автогруппировки помещений
  - Расчёт стоимости отделки по типу зоны
  - Экспорт в смету по зонам
- **R5.6 Сериализация** — сохранение данных помещений и зон

### R6 — Конструкции ?
- **Structure.h**:
  - `Column`: колонна (прямоугольная/круглая)
  - `Slab`: перекрытие (произвольный контур)
- **StructureTools.h**:
  - `ColumnTool`: размещение колонн с привязкой
  - `SlabTool`: рисование перекрытий по точкам
- **StructureRenderer.h**:
  - Визуализация колонн (вид сверху с сечением)
  - Полупрозрачная заливка перекрытий
- **Учёт порядка наложения**:
  1. Сетки/подложки
  2. Перекрытия (`Slab`)
  3. Помещения (`Room`)
  4. Стены (`Wall`)
  5. Колонны (`Column`)

### R7-R9 — Планируется ?
- R7: Анимации и визуальный дизайн
- R8: Расширенные аннотации
- R9: Производительность и оптимизация

---

## Модель данных

### Перечисление WorkState

```cpp
enum class WorkState {
    Existing,   // Существующее (обмер)
    Demolish,   // Под снос
    New         // Новое строительство
};
```

### Перечисление LocationLineMode

```cpp
enum class LocationLineMode {
    WallCenterline,      // Ось стены
    CoreCenterline,      // Ось несущего слоя
    FinishFaceExterior,  // Наружная чистовая
    FinishFaceInterior,  // Внутренняя чистовая
    CoreFaceExterior,    // Наружная несущая
    CoreFaceInterior     // Внутренняя несущая
};
```

### Структура Wall (планируется)

```cpp
class Wall : public Element {
    WorldPoint StartPoint;       // Начальная точка (мм)
    WorldPoint EndPoint;         // Конечная точка (мм)
    double Thickness;            // Толщина (мм)
    double Height;               // Высота (мм)
    WallType* Type;              // Тип стены
    LocationLineMode Mode;       // Режим линии размещения
    bool AllowJoinStart;         // Разрешить соединение в начале
    bool AllowJoinEnd;           // Разрешить соединение в конце
};
```

---

## Архитектура авторазмеров

### Принцип работы

1. При добавлении элемента AutoDimensionManager анализирует геометрию
2. Создаются размерные объекты:
   - Общая длина стены
   - Сегменты между проёмами
   - Ширина проёмов
   - Отступы от краёв стены
3. При изменении геометрии размеры пересчитываются (reflow)
4. Anchor Lock позволяет зафиксировать размер

### Anchor Lock

- Заблокированные размеры не изменяются автоматически
- Визуальный индикатор (замок) на размере
- Включается через панель свойств размера

---

## Система слоёв

### Связь слоёв с видами

| Вид | Видимые слои |
|-----|--------------|
| Обмерный | Existing |
| Демонтаж | Existing + Demolish |
| Новый | Existing + New |

### Класс Layer

```cpp
class Layer {
    hstring Name;                // Имя слоя
    bool IsVisible;              // Видимость
    bool IsLocked;               // Заблокирован для редактирования
    Windows::UI::Color Color;    // Цвет для отображения
    WorkState* LinkedWorkState;  // Связанное рабочее состояние (опционально)
};
```

---

## Импорт DXF

### Архитектура

Импорт DXF реализован через три компонента:

1. **DxfParser** (`DxfParser.h`) — парсер DXF файлов
2. **DxfReferenceLayer** (`DxfReference.h`) — хранение импортированной геометрии
3. **DxfReferenceRenderer** (`DxfReferenceRenderer.h`) — отрисовка на Win2D

### Поддерживаемые сущности DXF

| Сущность DXF | Класс | Описание |
|--------------|-------|----------|
| LINE | DxfLine | Прямая линия |
| POLYLINE | DxfPolyline | Полилиния (устаревший формат) |
| LWPOLYLINE | DxfPolyline | Легковесная полилиния с bulge |
| CIRCLE | DxfCircle | Окружность |
| ARC | DxfArc | Дуга |
| TEXT | DxfText | Однострочный текст |
| MTEXT | DxfText | Многострочный текст |

### Единицы измерения (INSUNITS)

| Код | Единицы | Коэффициент в мм |
|-----|---------|------------------|
| 1 | Дюймы | 25.4 |
| 2 | Футы | 304.8 |
| 4 | Миллиметры | 1.0 |
| 5 | Сантиметры | 10.0 |
| 6 | Метры | 1000.0 |

### Класс DxfParser

```cpp
class DxfParser {
    // Результат парсинга
    struct ParseResult {
        bool Success;
        std::wstring ErrorMessage;
        std::unique_ptr<DxfDocument> Document;
    };

    // Парсинг файла
    static ParseResult ParseFile(const std::wstring& filePath);
    
    // Масштаб для единиц
    static double GetScaleToMM(int insunits);
};
```

### Настройки импорта

```cpp
struct DxfImportSettings {
    double Scale;                    // Масштаб (по умолчанию 1.0)
    WorldPoint Offset;               // Смещение после импорта
    int OverrideUnits;               // Переопределение единиц (-1 = авто)
    WorkStateNative TargetWorkState; // Рабочее состояние
    bool ConvertLinesToWalls;        // Конвертация в стены (планируется)
    double DefaultWallThickness;     // Толщина стен по умолчанию
};
```

### Использование

1. Меню **Файл** ? **Импорт DXF...**
2. Выбрать файл .dxf
3. Настроить параметры в диалоге:
   - Масштаб импорта
   - Единицы исходного файла
   - Прозрачность подложки
4. Нажать **Импортировать**
5. Геометрия появится как полупрозрачная подложка
6. Рисовать стены поверх подложки

---

## Импорт IFC

### Архитектура

Импорт IFC реализован через три компонента:

1. **IfcParser** (`IfcParser.h`) — парсер IFC/STEP файлов
2. **IfcReferenceLayer** (`IfcReference.h`) — хранение импортированных элементов
3. **IfcReferenceRenderer** (`IfcReferenceRenderer.h`) — отрисовка на Win2D

### Поддерживаемые схемы IFC

- IFC2X3
- IFC4

### Поддерживаемые сущности IFC

| Сущность IFC | Класс | Описание |
|--------------|-------|----------|
| IFCWALL | IfcWall | Стена |
| IFCWALLSTANDARDCASE | IfcWall | Стандартная стена |
| IFCDOOR | IfcDoor | Дверь |
| IFCWINDOW | IfcWindow | Окно |
| IFCSPACE | IfcSpace | Помещение |
| IFCSLAB | IfcSlab | Перекрытие |
| IFCBUILDINGSTOREY | IfcBuildingStorey | Этаж |
| IFCCARTESIANPOINT | IfcPoint3D | Точка |
| IFCPOLYLINE | Points vector | Полилиния |

### Единицы измерения

| Тип единицы | Коэффициент в мм |
|-------------|------------------|
| MILLI + METRE | 1.0 |
| CENTI + METRE | 10.0 |
| METRE | 1000.0 |
| FOOT | 304.8 |
| INCH | 25.4 |

### Класс IfcParser

```cpp
class IfcParser {
    // Результат парсинга
    struct ParseResult {
        bool Success;
        std::wstring ErrorMessage;
        std::unique_ptr<IfcDocument> Document;
    };

    // Парсинг файла
    static ParseResult ParseFile(const std::wstring& filePath);
    
    // Масштаб для единиц
    static double GetScaleToMM(const std::wstring& unitName, double prefix);
};
```

### Настройки импорта

```cpp
struct IfcImportSettings {
    double Scale;                    // Масштаб (по умолчанию 1.0)
    WorldPoint Offset;               // Смещение после импорта
    bool ImportWalls;                // Импортировать стены
    bool ImportDoors;                // Импортировать двери
    bool ImportWindows;              // Импортировать окна
    bool ImportSpaces;               // Импортировать помещения
    bool ImportSlabs;                // Импортировать перекрытия
    int TargetStoreyIndex;           // Индекс этажа (-1 = все)
    WorkStateNative TargetWorkState; // Рабочее состояние
};
```

### Использование

1. Меню **Файл** ? **Импорт IFC...**
2. Выбрать файл .ifc
3. Просмотреть статистику файла:
   - Схема (IFC2X3, IFC4)
   - Название проекта
   - Количество элементов по типам
4. Настроить параметры в диалоге:
   - Чекбоксы для типов элементов
   - Масштаб импорта
   - Прозрачность подложки
5. Нажать **Импортировать**
6. Геометрия появится как цветная подложка:
   - Стены: тёмно-серые
   - Двери: коричневые
   - Окна: голубые
   - Помещения: светло-серые с названиями
7. Рисовать стены поверх подложки

### Рендеринг элементов IFC

| Тип элемента | Цвет | Стиль |
|--------------|------|-------|
| Стены | Тёмно-серый | Контуры или осевые линии |
| Двери | Коричневый | Прямоугольник + дуга открывания |
| Окна | Голубой | Прямоугольник + переплёт |
| Помещения | Светло-серый | Заливка + название |
| Перекрытия | Серый | Контуры |

---

## Привязка к стенам (M5.6)

### Обзор

Система расширенной привязки к стенам обеспечивает точное позиционирование при размещении стен, аналогично Revit.

### Плоскости привязки

| Тип | Описание | Маркер |
|-----|----------|--------|
| Endpoint | Конечные точки стены | Квадрат |
| Midpoint | Середина стены | Треугольник |
| Centerline | Ось стены | Круг с крестом |
| CoreCenterline | Ось несущего слоя | Круг с крестом (голубой) |
| FinishFaceExterior | Наружная чистовая | Ромб (зелёный) |
| FinishFaceInterior | Внутренняя чистовая | Ромб (оранжевый) |
| CoreFaceExterior | Наружная несущая | Ромб (зелёный) |
| CoreFaceInterior | Внутренняя несущая | Ромб (оранжевый) |

### Режимы привязки

| Режим | Описание |
|-------|----------|
| Авто | Автоматический выбор ближайшей плоскости |
| Ось стены | Привязка только к центральной оси |
| Наружная | Привязка к наружной чистовой грани |
| Внутренняя | Привязка к внутренней чистовой грани |
| Ядро (нар.) | Привязка к наружной грани несущего слоя |
| Ядро (вн.) | Привязка к внутренней грани несущего слоя |

### Горячие клавиши

| Клавиша | Действие |
|---------|----------|
| Tab | Переключение режима привязки |
| Space | Переворот стены |
| Escape | Отмена размещения |

### Класс WallSnapSystem

```cpp
class WallSnapSystem {
    // Настройки
    void SetSnapThresholdPixels(double pixels);
    void SetReferenceMode(SnapReferenceMode mode);
    void CycleReferenceMode();  // Tab key

    // Поиск привязки
    WallSnapCandidate FindBestSnap(
        const WorldPoint& cursor,
        const std::vector<std::unique_ptr<Wall>>& walls,
        double zoomFactor,
        uint64_t excludeWallId = 0);

    // Линии привязки для стены
    std::vector<WallReferenceLine> GetWallReferenceLines(const Wall& wall);

    // Вспомогательные методы
    static std::wstring GetSnapPlaneName(WallSnapPlane plane);
    static Windows::UI::Color GetSnapPlaneColor(WallSnapPlane plane);
};
```

### Приоритет привязки

1. **Endpoints** — конечные точки (высший приоритет)
2. **Midpoint** — середина стены
3. **Face references** — грани стены
4. **Centerline** — ось стены (низший приоритет)

---

## Система отмены/повтора (M6.5)

### Архитектура

Система отмены реализована через паттерн Command:

```cpp
// Интерфейс команды
class ICommand {
    virtual void Execute() = 0;
    virtual void Undo() = 0;
    virtual std::wstring GetDescription() = 0;
};

// Реализованные команды
class AddWallCommand : public ICommand;     // Добавление стены
class RemoveWallCommand : public ICommand;  // Удаление стены
class ModifyWallCommand : public ICommand;  // Изменение стены
```

### Использование

| Действие | Меню | Горячая клавиша |
|----------|------|-----------------|
| Отменить | Правка ? Отменить | Ctrl+Z |
| Повторить | Правка ? Повторить | Ctrl+Y |

---

## Редактор типов стен (M6.5)

### Обзор

Редактор типов стен позволяет создавать и изменять структуры стен с многослойной конфигурацией.

### Использование

1. Меню **Правка** ? **Редактор типов стен...**
2. Выбрать тип стены из списка
3. Добавить/удалить слои
4. Настроить для каждого слоя:
   - Название материала
   - Толщина (мм)
   - Функция (Finish/Core/Insulation)
5. Нажать **Сохранить**

### Класс WallTypeEditorController

```cpp
class WallTypeEditorController {
    // Создание и удаление типов
    void CreateNewType();
    void DeleteSelectedType();
    
    // Работа со слоями
    void AddLayerToSelected();
    void RemoveLayerFromSelected();
    
    // Форматирование для UI
    static std::wstring FormatWallTypeSummary(const WallType* type);
    static std::wstring FormatWallTypeLayers(const WallType* type);
};
```

---

## Конвертация подложек в стены (M6.5)

### DXF ? Стены

1. Импортировать DXF файл
2. Меню **Файл** ? **Конвертировать DXF в стены**
3. Все линии и полилинии преобразуются в стены

**Параметры:**
- Толщина: 150 мм (по умолчанию)
- Минимальная длина: 50 мм
- WorkState: по активному виду

### IFC ? Стены

1. Импортировать IFC файл
2. Меню **Файл** ? **Конвертировать IFC в стены**
3. Все IfcWall элементы преобразуются в нативные стены

**Параметры:**
- Толщина: извлекается из контура или из свойства IFC
- Имя стены: сохраняется из IFC
- WorkState: по активному виду

---

## Система сметных расчётов (M7)

### Обзор

Система расчёта смет автоматически вычисляет объёмы работ на основе геометрии стен и экспортирует результаты в Excel или CSV.

### Архитектура

```cpp
// Строка сметы
struct QuantityItem {
    std::wstring Category;      // Категория работ
    std::wstring Description;   // Описание
    std::wstring Unit;          // Единица (м, м?, м?)
    double Quantity;            // Количество
    double UnitPrice;           // Цена за единицу
    double TotalPrice;          // Сумма
    WorkStateNative WorkState;  // Рабочее состояние
};

// Результат расчёта
struct EstimationResult {
    WallQuantitySummary DemolitionWalls;  // Стены под снос
    WallQuantitySummary NewWalls;         // Новые стены
    std::vector<QuantityItem> Items;      // Строки сметы
    double DemolitionSubtotal;            // Итого демонтаж
    double ConstructionSubtotal;          // Итого строительство
    double Contingency;                   // Непредвиденные (10%)
    double GrandTotal;                    // Всего
};
```

### Группировка

Смета поддерживает группировку по:
- **WorkState** — Демонтаж / Новое строительство
- **Тип стены** — группировка по типам стен
- **Материал** — группировка по материалам слоёв

### Расчёт количеств

| Показатель | Формула |
|------------|---------|
| Длина стены | distance(start, end) |
| Площадь стены | длина ? высота |
| Объём стены | длина ? высота ? толщина |
| Площадь материала | длина ? высота (на слой) |
| Объём материала | длина ? высота ? толщина_слоя |

### Цены по умолчанию

| Работа/Материал | Цена (?/м?) |
|-----------------|-------------|
| Демонтаж стен | 500 |
| Кирпичная кладка | 3 500 |
| Гипсокартон | 1 200 |
| Бетон | 4 500 |
| Штукатурка | 800 |
| Вывоз мусора | 1 500 ?/м? |

### Дополнительные расчёты

- **Вывоз мусора** — 0.1 м? на 1 м? демонтажа
- **Непредвиденные расходы** — 10% от суммы

### Экспорт

| Формат | Особенности |
|--------|-------------|
| Excel (.xlsx) | Форматирование, стили, границы ячеек |
| CSV (.csv) | UTF-8 с BOM, точка с запятой как разделитель |

### Использование

1. Создайте стены с WorkState = Снос или Новое
2. Меню **Файл** ? **Показать сводку сметы** — предпросмотр
3. Меню **Файл** ? **Экспорт сметы в Excel...** — экспорт

---

## Полный список горячих клавиш

| Клавиша | Действие |
|---------|----------|
| Ctrl+N | Новый проект |
| Ctrl+O | Открыть проект |
| Ctrl+S | Сохранить проект |
| Ctrl+Z | Отменить |
| Ctrl+Y | Повторить |
| V | Инструмент выбора |
| W | Инструмент стены |
| R | Инструмент размера |
| Tab | Переключить режим привязки |
| Space | Переворот стены |
| Escape | Отмена текущего действия |
| Delete | Удалить выделенное |

---

## Полный список меню

### Файл
- Новый (Ctrl+N)
- Открыть (Ctrl+O)
- Сохранить (Ctrl+S)
- Сохранить как...
- Импорт DXF...
- Импорт IFC...
- Конвертировать DXF в стены
- Конвертировать IFC в стены
- Экспорт сметы в Excel...
- Экспорт сметы в CSV...
- Показать сводку сметы
- Выход

### Правка
- Отменить (Ctrl+Z)
- Повторить (Ctrl+Y)
- Удалить (Delete)
- Редактор типов стен...

### Вид
- Обмерный (Existing)
- Демонтаж (Demolition)
- Новый (Construction)
- Настройки вида...

---

*Обновлено: 2025-01-21*
